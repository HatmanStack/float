name: Deploy Backend Production

on:
  workflow_dispatch:
    inputs:
      confirm_production:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
      deployment_notes:
        description: 'Deployment notes (what changed, why deploying)'
        required: true

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_production }}" != "DEPLOY TO PRODUCTION" ]; then
            echo "âŒ Production deployment not confirmed"
            echo "You must type 'DEPLOY TO PRODUCTION' exactly to proceed"
            exit 1
          fi
          echo "âœ… Production deployment confirmed"

      - name: Check branch
        run: |
          BRANCH="${{ github.ref }}"
          if [ "$BRANCH" != "refs/heads/main" ]; then
            echo "âš ï¸ Warning: Deploying from branch $BRANCH, not main"
            echo "This is unusual for production deployments"
          else
            echo "âœ… Deploying from main branch"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_STAGING }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_STAGING }}
          aws-region: ${{ secrets.AWS_REGION_STAGING }}

      - name: Check staging health
        run: |
          echo "Checking staging environment health..."

          # Check if staging stack exists and is healthy
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name float-meditation-staging \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "NOT_FOUND")

          if [ "$STACK_STATUS" != "UPDATE_COMPLETE" ] && [ "$STACK_STATUS" != "CREATE_COMPLETE" ]; then
            echo "âš ï¸ Staging stack status: $STACK_STATUS"
            echo "Recommend verifying staging before production deployment"
          else
            echo "âœ… Staging stack healthy: $STACK_STATUS"
          fi

      - name: Deployment notes
        run: |
          echo "## Production Deployment Request" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Requested by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Notes:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ github.event.inputs.deployment_notes }}" >> $GITHUB_STEP_SUMMARY

  create-changeset:
    name: Create Production Change Set
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    timeout-minutes: 20
    outputs:
      changeset-name: ${{ steps.create-changeset.outputs.changeset_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PRODUCTION }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PRODUCTION }}
          aws-region: ${{ secrets.AWS_REGION_PRODUCTION }}

      - name: Validate SAM template
        run: |
          cd infrastructure
          sam validate --lint

      - name: Build SAM application
        run: |
          cd infrastructure
          sam build --use-container

      - name: Create change set
        id: create-changeset
        run: |
          cd infrastructure
          sam deploy \
            --no-execute-changeset \
            --stack-name float-meditation-production \
            --s3-prefix float-meditation-production \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              Environment=production \
              FFmpegLayerArn=${{ secrets.FFMPEG_LAYER_ARN_PRODUCTION }} \
              GKey=${{ secrets.G_KEY_PRODUCTION }} \
              OpenAIKey=${{ secrets.OPENAI_API_KEY_PRODUCTION }} \
              XIKey=${{ secrets.XI_KEY_PRODUCTION }}

          # Capture the exact changeset name that was just created
          CHANGESET_NAME=$(aws cloudformation list-change-sets \
            --stack-name float-meditation-production \
            --query 'Summaries[0].ChangeSetName' \
            --output text)

          echo "changeset_name=$CHANGESET_NAME" >> $GITHUB_OUTPUT

          echo "## ðŸ” Change Set Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Change Set Name:** \`$CHANGESET_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Change set has been created but NOT executed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the change set in AWS CloudFormation console" >> $GITHUB_STEP_SUMMARY
          echo "2. Approve the 'deploy-production' environment in GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "3. The workflow will execute the change set after approval" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: Execute Production Deployment
    runs-on: ubuntu-latest
    needs: create-changeset
    timeout-minutes: 30
    environment:
      name: production
      url: ${{ steps.outputs.outputs.api_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PRODUCTION }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PRODUCTION }}
          aws-region: ${{ secrets.AWS_REGION_PRODUCTION }}

      - name: Execute change set
        id: deploy
        run: |
          # Execute the exact change set created in previous job
          CHANGESET_NAME="${{ needs.create-changeset.outputs.changeset-name }}"
          echo "Executing change set: $CHANGESET_NAME"

          aws cloudformation execute-change-set \
            --stack-name float-meditation-production \
            --change-set-name "$CHANGESET_NAME"

          # Wait for stack update to complete
          aws cloudformation wait stack-update-complete \
            --stack-name float-meditation-production

          echo "âœ… Production deployment complete!"

      - name: Get stack outputs
        id: outputs
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name float-meditation-production \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "### Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production API Endpoint:** $API_URL" >> $GITHUB_STEP_SUMMARY

      - name: Run production smoke tests
        run: |
          API_URL="${{ steps.outputs.outputs.api_url }}"
          echo "Testing production endpoint: $API_URL"

          # Make request with timeout and capture HTTP status
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/smoke_test_response.json \
            --max-time 30 \
            -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -d @infrastructure/test-requests/summary-request.json)

          RESPONSE=$(cat /tmp/smoke_test_response.json)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $RESPONSE"

          # Validate HTTP status code
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Smoke test failed - HTTP $HTTP_CODE"
            echo "**Smoke Test:** âŒ Failed (HTTP $HTTP_CODE) - INVESTIGATE IMMEDIATELY" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Validate response contains required fields
          VALIDATION_PASSED=true
          for field in "sentiment_label" "intensity" "user_summary"; do
            if ! echo "$RESPONSE" | grep -q "$field"; then
              echo "âŒ Smoke test failed - missing field: $field"
              VALIDATION_PASSED=false
            fi
          done

          if [ "$VALIDATION_PASSED" = true ]; then
            echo "âœ… Production smoke test passed"
            echo "**Smoke Test:** âœ… Passed (HTTP 200, all fields present)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Production smoke test failed - incomplete response"
            echo "**Smoke Test:** âŒ Failed (missing fields) - INVESTIGATE IMMEDIATELY" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Monitor initial traffic
        run: |
          echo "Monitoring production Lambda for 2 minutes..."
          sleep 120

          # Check for errors in CloudWatch Logs
          ERROR_COUNT=$(aws logs filter-log-events \
            --log-group-name /aws/lambda/float-meditation-production \
            --start-time $(date -d '5 minutes ago' +%s)000 \
            --filter-pattern "ERROR" \
            --query 'events[*]' \
            --output json | jq '. | length')

          echo "Errors in last 5 minutes: $ERROR_COUNT"

          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "âš ï¸ Warning: $ERROR_COUNT errors detected in CloudWatch Logs"
            echo "**Errors Detected:** $ERROR_COUNT (review logs)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No errors detected in initial monitoring"
            echo "**Initial Monitoring:** âœ… No errors" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deployment complete summary
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Stack Name:** float-meditation-production" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ secrets.AWS_REGION_PRODUCTION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Continue to monitor CloudWatch Logs and metrics." >> $GITHUB_STEP_SUMMARY

  rollback-plan:
    name: Rollback Instructions
    runs-on: ubuntu-latest
    needs: deploy-production
    if: failure()

    steps:
      - name: Provide rollback instructions
        run: |
          echo "## âš ï¸ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Immediate Actions:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check CloudFormation Events in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Review error messages in workflow logs above" >> $GITHUB_STEP_SUMMARY
          echo "3. If deployment partially succeeded, consider rollback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback Commands:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Option 1: Rollback via CloudFormation" >> $GITHUB_STEP_SUMMARY
          echo "aws cloudformation rollback-stack --stack-name float-meditation-production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Option 2: Deploy previous version" >> $GITHUB_STEP_SUMMARY
          echo "cd infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "./scripts/deploy-production.sh" >> $GITHUB_STEP_SUMMARY
          echo "# (After checking out previous commit)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Contact:" >> $GITHUB_STEP_SUMMARY
          echo "Notify the team immediately about the failed deployment." >> $GITHUB_STEP_SUMMARY
